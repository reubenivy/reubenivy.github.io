<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Recap</title>
	
	<script>
      if (sessionStorage.getItem("authenticated") !== "true") {
        // Redirect to login page if not
        window.location.href = "2025_login.html";
      }
    </script>
	
    <style>
        /* 1. Base Setup */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Georgia', serif;
        }

        /* 2. Background and Section Container */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            overflow: hidden;
        }
        .background-image {
            width: 100%;
            height: 100%;
            background-image: url('https://reubenivy.github.io/moments/5_apr_2025_5.jpg');
            background-size: cover;
            background-position: center;
            animation: breathe 20s ease-in-out infinite alternate;
        }
        @keyframes breathe {
            0% { transform: scale(1); }
            100% { transform: scale(1.15); } /* Slow zoom-in effect */
        }

        /* 3. Full-Screen Content Area */
        #content-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            transition: opacity 1s ease-in-out;
            opacity: 0;
            z-index: 10;
        }

        /* 4. Text Section Styling */
        .text-section {
            /* FIX: Ensure text sections have a black background */
            background-color: black; 
            color: white;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 5vw;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .subtext {
            font-size: 0.5em;
            display: block;
            margin-top: 10px;
        }
        .text-content {
            /* The main container for the text array */
            text-shadow: 0 0 10px rgba(0,0,0,1); 
            padding: 20px;
        }
        
        /* ‚≠êÔ∏è NEW CLASS FOR ARRAY LINES ‚≠êÔ∏è */
        .text-array-line {
            display: block; /* Ensures each line is on a new line */
            margin: 0.5em 0; /* Vertical spacing between lines */
            opacity: 0;
            transition: opacity 1s ease-in-out; /* <-- This controls the fade duration */
        }
        .text-array-line.visible {
            opacity: 1;
        }


        /* 5. Photo Stack Styling */
        .stack-image {
            position: absolute;
            top: 50%;
            left: 50%;
            max-width: 85vw;
            max-height: 85vh;
            width: auto;
            height: auto;

            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            border: 10px solid white;
            border-radius: 4px;

            /* Initial state: Hidden below screen */
            transform: translate(-50%, 150vh) rotate(0deg);
            opacity: 0;
            /* Transition for the "fly-in" effect */
            transition: all 1.2s cubic-bezier(0.25, 1, 0.5, 1);
            pointer-events: none;
        }
        .stack-image.visible {
            opacity: 1;
        }
        
        /* ‚≠êÔ∏è VIDEO STYLING ‚≠êÔ∏è */
        .video-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000; /* Ensure black background behind video */
        }
        #cinematic-video {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Contain the video within the screen */
            opacity: 0;
            transition: opacity 1s ease-in-out;
            pointer-events: none;
        }
        #cinematic-video.visible {
            opacity: 1;
        }
        /* ‚≠êÔ∏è END VIDEO STYLING ‚≠êÔ∏è */

        /* 6. Unmute Overlay Styling (for Click 1 & 2) */
        #unmute-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: flex;
            flex-direction: column; /* To stack message and spinner */
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: opacity 1s ease-out;
        }

        .unmute-message {
            color: white;
            font-size: 3vw;
            text-align: center;
            padding: 20px;
            border: 3px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: pulse 1.5s infinite alternate;
            margin-bottom: 30px; /* Space between message and spinner */
            min-width: 40vw; 
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.9; }
            100% { transform: scale(1.05); opacity: 1; }
        }

        /* 7. Spinner CSS */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none; /* Initially hidden */
        }
        .spinner.visible {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ‚≠êÔ∏è NEW: Mobile Video Play Button Styling (Click 3) ‚≠êÔ∏è */
        #mobile-video-prompt {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 50; /* Above the video, below the main overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-in-out;
        }
        #mobile-video-prompt.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .video-play-button {
            cursor: pointer;
            color: white;
            font-size: 3vw;
            text-align: center;
            padding: 25px 40px;
            border: 3px solid white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.7);
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 5px;
            pointer-events: auto; /* Allow click */
            transition: all 0.3s ease;
            animation: pulse 1.5s infinite alternate; /* Re-use pulse animation */
        }
        .video-play-button:hover {
            transform: scale(1.05);
            background-color: rgba(0, 0, 0, 0.9);
        }
    </style>
	<link rel="icon" type="image/x-icon" href="favicon.ico" />
</head>
<body>

    <div class="background-container">
        <div class="background-image"></div>
    </div>

    <div id="content-area">
    </div>

    <div id="unmute-overlay">
        <div class="unmute-message" id="unmute-message">
            üîä Tap to Load Audio and Stabilize Experience
        </div>
        <div class="spinner" id="loading-spinner"></div>
    </div>
    
    <div id="mobile-video-prompt" class="hidden">
        <div class="video-play-button" id="video-play-button">
            ‚ñ∂Ô∏è Tap to Play Video
        </div>
    </div>

    <script>
        // ==========================================
        // üåü DEVICE DETECTION üåü
        // ==========================================
        const isMobile = /Mobi|Android/i.test(navigator.userAgent) || (navigator.maxTouchPoints > 0);
        console.log(`Device Detected: ${isMobile ? 'Mobile' : 'Desktop'}`);
        
        // ==========================================
        // üåü SECTION CONTROL ARRAY üåü
        // ==========================================
        const pageContent = [
			{
                type: 'text',
                content: 'It all started with a swipe',
                duration: 5000,
                track: "https://reubenivy.github.io/recap_asset/canon_in_d.mp3"
            },
            {
                type: 'photos',
                content: [
                    "https://reubenivy.github.io/moments/07_jan_2025.png"
                ],
                duration: 11000,
                track: "https://reubenivy.github.io/recap_asset/canon_in_d.mp3",
                photoDelay: 5000
            },
			{
                type: 'text',
                content: 'Our first date',
                duration: 5000,
                track: "https://reubenivy.github.io/recap_asset/canon_in_d.mp3"
            },
            {
                type: 'photos',
                content: [
					"https://reubenivy.github.io/recap_asset/stay_bp.png",
					"https://reubenivy.github.io/recap_asset/stay_bp_2.png",
					"https://reubenivy.github.io/recap_asset/first_date.png",
                    "https://reubenivy.github.io/moments/18_jan_2025.png",
                ],
                duration: 26000,
                track: "https://reubenivy.github.io/recap_asset/canon_in_d.mp3",
                photoDelay: 5000
            },
			{
                type: 'text',
                content: 'After a few dates,<br>we became official after 30km in a day<br>Â•πËØ¥Â•Ω!',
                duration: 7500,
                track: "https://reubenivy.github.io/recap_asset/nu_hai_2.mp3"
            },
			{
                type: 'photos',
                content: [
                    "https://reubenivy.github.io/moments/14_feb_2025_1.jpg",
                    "https://reubenivy.github.io/moments/14_feb_2025_2.jpg",
					"https://reubenivy.github.io/recap_asset/pangsua_pond.png",
					"https://reubenivy.github.io/moments/14_feb_2025_5.jpg",
					"https://reubenivy.github.io/moments/18_feb_2025_2.jpg"
                ],
                duration: 26000,
                track: "https://reubenivy.github.io/recap_asset/nu_hai_2.mp3",
                photoDelay: 5000
            },
			{
                type: 'text',
                content: 'Couple Profile Pic moment',
                duration: 7500,
                track: "https://reubenivy.github.io/recap_asset/nu_hai_2.mp3"
            },
			{
                type: 'photos',
                content: [
                    "https://reubenivy.github.io/recap_asset/change_pic_feb_21.png",
					"https://reubenivy.github.io/recap_asset/couple_pic.png"
                ],
                duration: 16000,
                track: "https://reubenivy.github.io/recap_asset/nu_hai_2.mp3",
                photoDelay: 5000
            },
			{
                type: 'text',
                content: 'Every night before we sleep',
                duration: 7500,
                track: "https://reubenivy.github.io/recap_asset/we_are_young_2.mp3"
            },
			{
                type: 'photos',
                content: [
					"https://reubenivy.github.io/recap_asset/chat_4.png",
					"https://reubenivy.github.io/recap_asset/chat_5.png",
					"https://reubenivy.github.io/recap_asset/chat_6.jpg",
					"https://reubenivy.github.io/recap_asset/chat_7.png",
					"https://reubenivy.github.io/recap_asset/chat_8.png",
					"https://reubenivy.github.io/recap_asset/chat_9.png",
					"https://reubenivy.github.io/recap_asset/chat_10.png",
					"https://reubenivy.github.io/recap_asset/chat_11.png",
					"https://reubenivy.github.io/recap_asset/chat_12.png",
					"https://reubenivy.github.io/recap_asset/chat_1.png",
					"https://reubenivy.github.io/recap_asset/chat_2.png",
					"https://reubenivy.github.io/recap_asset/chat_3.png",
					"https://reubenivy.github.io/recap_asset/chat_13.png",
                ],
                duration: 42000,
                track: "https://reubenivy.github.io/recap_asset/we_are_young_2.mp3",
                photoDelay: 3000
            },
			{
                type: 'text',
                content: 'Êàë‰ª¨‰∏ÄËµ∑ËøΩÁöÑÂâßs',
                duration: 7500,
                track: "https://reubenivy.github.io/recap_asset/hanzawa_2.mp3"
            },
			{
                type: 'photos',
                content: [
                    "https://reubenivy.github.io/moments/13_apr_2025_1.jpg",
                    "https://reubenivy.github.io/moments/18_may_2025_1.jpg",
					"https://reubenivy.github.io/moments/1_jun_2025_5.jpg",
					"https://reubenivy.github.io/recap_asset/reborn_rich.jpg",
					"https://reubenivy.github.io/recap_asset/legal_high.jpg",
					"https://reubenivy.github.io/recap_asset/couple_or_trouble.jpg",
					"https://reubenivy.github.io/moments/4_oct_2025_0.jpg",
					"https://reubenivy.github.io/recap_asset/spy_family.jpg",
					"https://reubenivy.github.io/recap_asset/news_queen.jpg",
					"https://reubenivy.github.io/recap_asset/heaven_official_blessing.jpg"
                ],
                duration: 30000,
                track: "https://reubenivy.github.io/recap_asset/hanzawa_2.mp3",
                photoDelay: 3000
            },
			{
                type: 'text',
                content: 'And ÁîµÂΩ±s',
                duration: 7500,
                track: "https://reubenivy.github.io/recap_asset/zoo.mp3"
            },
			{
                type: 'photos',
                content: [
                    "https://reubenivy.github.io/moments/22_feb_2025_2.jpeg",
					"https://reubenivy.github.io/moments/1_mar_2025_2.jpg",
					"https://reubenivy.github.io/moments/8_mar_2025_2.jpg",
					"https://reubenivy.github.io/moments/22_mar_2025_5.png",
					"https://reubenivy.github.io/moments/22_mar_2025_2.jpeg",
					"https://reubenivy.github.io/moments/29_mar_2025_5.jpg",
					"https://reubenivy.github.io/moments/4_may_2025_3.jpg",
					"https://reubenivy.github.io/moments/25_may_2025_1.jpg",
					"https://reubenivy.github.io/recap_asset/loving_vincent.jpg",
					"https://reubenivy.github.io/moments/1_jun_2025_2.jpg",
					"https://reubenivy.github.io/moments/12_jul_2025_2.jpg",
					"https://reubenivy.github.io/moments/19_jul_2025_2.jpg",
					"https://reubenivy.github.io/moments/27_jul_2025_3.jpg",
					"https://reubenivy.github.io/recap_asset/zootopia.jpg",
					"https://reubenivy.github.io/moments/29_nov_2025_10.jpg",
					"https://reubenivy.github.io/moments/6_dec_2025_3.jpg"
                ],
                duration: 35000,
                track: "https://reubenivy.github.io/recap_asset/zoo.mp3",
                photoDelay: 2000
            },
			{
                type: 'text',
                content: 'And Piano Concerts',
                duration: 7500,
                track: "https://reubenivy.github.io/recap_asset/nocturne.mp3"
            },
			{
                type: 'photos',
                content: [
                    "https://reubenivy.github.io/moments/9_mar_2025_1.jpg",
					"https://reubenivy.github.io/moments/12_apr_2025_3.jpg",
					"https://reubenivy.github.io/moments/12_apr_2025_4.jpg",
					"https://reubenivy.github.io/moments/14_may_2025_1.jpg",
					"https://reubenivy.github.io/moments/25_jul_2025_4.jpeg",
					"https://reubenivy.github.io/moments/23_oct_2025_3.jpg"
					
                ],
                duration: 33000,
                track: "https://reubenivy.github.io/recap_asset/nocturne.mp3",
                photoDelay: 5000
            },
			{
                type: 'text',
                content: 'And many more performances and experiences',
                duration: 7500,
                track: "https://reubenivy.github.io/recap_asset/lalaland.mp3"
            },
			{
                type: 'photos',
                content: [
					"https://reubenivy.github.io/moments/20_mar_2025_1.png",
                    "https://reubenivy.github.io/moments/20_mar_2025_5.jpg",
					"https://reubenivy.github.io/moments/20_mar_2025_6.jpg",
					"https://reubenivy.github.io/moments/20_mar_2025_3.jpeg",
					"https://reubenivy.github.io/moments/20_mar_2025_4.jpeg",
					"https://reubenivy.github.io/moments/25_may_2025_2.jpg",
					"https://reubenivy.github.io/moments/25_may_2025_5.jpg",
					"https://reubenivy.github.io/moments/25_may_2025_6.jpg",
					"https://reubenivy.github.io/moments/15_mar_2025_5.jpg",
					"https://reubenivy.github.io/moments/15_mar_2025_4.jpg",
					"https://reubenivy.github.io/moments/1_feb_2025_1.jpg",
					"https://reubenivy.github.io/moments/15_mar_2025_6.jpg",
					"https://reubenivy.github.io/moments/5_apr_2025_3.jpeg",
					"https://reubenivy.github.io/moments/15_apr_2025_3.jpeg",
					"https://reubenivy.github.io/moments/7_may_2025_1.jpeg",
					"https://reubenivy.github.io/moments/22_jun_2025_4.jpeg",
					"https://reubenivy.github.io/moments/4_jul_2025_4.jpg",
					"https://reubenivy.github.io/moments/5_jul_2025_3.jpg",
					"https://reubenivy.github.io/moments/14_jul_2025_2.jpeg",
					"https://reubenivy.github.io/moments/14_jul_2025_5.jpeg",
					"https://reubenivy.github.io/moments/14_aug_2025_6.jpeg",
					"https://reubenivy.github.io/moments/14_aug_2025_2.jpeg",
					"https://reubenivy.github.io/moments/14_aug_2025_18.jpg",
					"https://reubenivy.github.io/moments/7_sep_2025_7.jpeg",
					"https://reubenivy.github.io/moments/4_oct_2025_1.jpeg",
					"https://reubenivy.github.io/moments/4_oct_2025_4.jpg",
					"https://reubenivy.github.io/moments/25_oct_2025_1.jpg",
					"https://reubenivy.github.io/moments/29_nov_2025_6.jpg",
					"https://reubenivy.github.io/moments/6_dec_2025_5.jpg",
					"https://reubenivy.github.io/moments/6_dec_2025_1.jpeg",
					"https://reubenivy.github.io/recap_asset/fam_lunch.jpeg",
					"https://reubenivy.github.io/moments/18_dec_2025_3.jpeg",
					"https://reubenivy.github.io/moments/18_dec_2025_6.jpg"
				],
                duration: 70000,
                track: "https://reubenivy.github.io/recap_asset/lalaland.mp3",
                photoDelay: 2000
            },
            {
                type: 'text_array', 
                content: ['Life become more beautiful since', '07 Jan 2025 when you entered my life', 'Èô™‰º¥ÊòØÊúÄÈïø‰πÖÁöÑÂëäÁôΩ', 'ÊàëÊÉ≥‰∏ÄÁõ¥Èô™‰º¥‰Ω† ‚ù§Ô∏è'],
                duration: 5000, // Duration for *EACH* line before moving to the next
                track: ''
            },
            {
                type: 'video',
                content: "https://reubenivy.github.io/recap_asset/wise_men_say_2.mp4", 
                duration: 77000, 
                track: ''
            },
            {
                type: 'text',
                content: 'RM = IM<br>&<br>R ‚ù§Ô∏è I',
                duration: 9999999,
                track: ''
            },
        ];

        // ==========================================
        // CONSTANTS AND FLOW CONTROL LOGIC
        // ==========================================

        const CROSSFADE_DURATION = 2000;
        const CROSSFADE_STEPS = 50;
        const CROSSFADE_INTERVAL = CROSSFADE_DURATION / CROSSFADE_STEPS;
        const VOLUME_STEP = 1 / CROSSFADE_STEPS;
        const INITIAL_DELAY_AFTER_UNLOCK = 500;

        let wakeLock = null; 
        let currentVideo = null; 

        const contentArea = document.getElementById('content-area');
        const unmuteOverlay = document.getElementById('unmute-overlay');
        const unmuteMessage = document.getElementById('unmute-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const mobileVideoPrompt = document.getElementById('mobile-video-prompt');
        const videoPlayButton = document.getElementById('video-play-button');

        let currentAudio = null;
        let currentSectionIndex = 0;
        let hasStarted = false;

        const audioMap = {};
        let allUniqueTracks = [];
        let videoUrlToUnlock = null;


        function initializeAudio() {
            // Find all unique track URLs in the page content
            allUniqueTracks = [...new Set(pageContent.map(s => s.track).filter(t => t && t.endsWith('.mp3')))];
            
            // Find the video URL. We will *only* pre-unlock it if we're on desktop.
            const videoSection = pageContent.find(s => s.type === 'video');
            if (videoSection && !isMobile) { // üõë DESKTOP ONLY: Pre-unlock video media element
                videoUrlToUnlock = videoSection.content;
            } else if (videoSection) {
                   // Mobile: Store URL, but don't add to the unlock array
                   videoUrlToUnlock = videoSection.content;
            }

            // Create Audio objects for each unique track
            allUniqueTracks.forEach(trackUrl => {
                const audio = new Audio(trackUrl);
                audio.loop = true;
                audio.preload = 'auto';
                audio.volume = 0; 
                audioMap[trackUrl] = audio;
            });
        }

        // Helper Functions (unchanged)
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // --- WAKE LOCK FUNCTIONS (Unchanged) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen Wake Lock acquired.');
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen Wake Lock released by system.');
                    });
                } catch (err) {
                    console.error(`Wake Lock error: ${err.name}, ${err.message}`);
                }
            } else {
                console.warn('Wake Lock API not supported by this browser/device.');
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release()
                    .then(() => {
                        console.log('Screen Wake Lock successfully released.');
                        wakeLock = null;
                    })
                    .catch((err) => {
                        console.error('Failed to release Wake Lock:', err);
                    });
            }
        }
        
        // --- AUDIO/VIDEO UNLOCK FUNCTIONS (Modified for conditional video unlock) ---

        function unlockTrackSequentially(mediaElement) {
            return new Promise(resolve => {
                if (!mediaElement) return resolve();

                // Play the track. Since 'muted' is true, this is silent.
                mediaElement.play().then(() => {
                    mediaElement.pause();
                    mediaElement.currentTime = 0;
                    resolve();
                }).catch(e => {
                    console.warn("Track failed to unlock/play (expected if silent):", e);
                    resolve(); 
                });
            });
        }
        
        async function runSequentialUnlock() {
            // State 1: Loading
            unmuteMessage.innerHTML = 'Preloading and stabilizing media...'; // Updated message
            unmuteMessage.style.animation = 'none'; // Stop pulse
            loadingSpinner.classList.add('visible');
            
            let allMedia = [...allUniqueTracks.map(url => audioMap[url])];
            let tempVideo = null;
            
            // üõë ONLY Preload/Unlock Video on Desktop
            if (!isMobile && videoUrlToUnlock) {
                tempVideo = document.createElement('video');
                tempVideo.src = videoUrlToUnlock;
                tempVideo.muted = true;
                tempVideo.preload = 'auto';
                allMedia.push(tempVideo); // Add to media array for unlocking
            }
            
            // CRITICAL STEP A: Force mute all media tracks for silent unlock
            for (const media of allMedia) {
                if (media) {
                    media.muted = true; // FORCE MUTE
                }
            }

            // Perform the sequential unlock
            for (const media of allMedia) {
                if (media) {
                    await unlockTrackSequentially(media);
                }
            }
            
            // CRITICAL STEP B: Un-mute all media tracks
            for (const media of allMedia) {
                if (media) {
                    media.muted = false; // ALLOW SOUND (still volume 0)
                }
            }
            
            // CRITICAL STEP C: Force pause all tracks immediately after unmuting 
             for (const media of allMedia) {
                if (media) {
                    media.pause(); 
                    media.currentTime = 0;
                }
            }


            // State 2: Ready
            unmuteMessage.innerHTML = '‚úÖ Loading Complete. Tap to Begin Story üé¨';
            unmuteMessage.style.animation = 'pulse 1.5s infinite alternate';
            loadingSpinner.classList.remove('visible');
            
            // Re-enable the click handler for the second step
            unmuteOverlay.addEventListener('click', startCinematicStorySequence, { once: true });
        }


        // üé∂ Music Crossfade Logic üé∂ (Unchanged)
        function playTrack(filename) {
            const previousAudio = currentAudio;

            // Stop any playing video before starting a track 
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.remove();
                currentVideo = null;
            }

            const newAudio = audioMap[filename];
            if (!newAudio) {
                if (previousAudio) {
                    previousAudio.pause();
                    previousAudio.volume = 0;
                    previousAudio.currentTime = 0;
                    currentAudio = null;
                }
                return;
            }

            if (previousAudio && previousAudio === newAudio) {
                return;
            }

            currentAudio = newAudio;
            
            newAudio.play().then(() => {
                // Play started successfully, proceed with fade logic
            }).catch(error => {
                console.error(`Playback error on track switch for ${filename}:`, error);
            });

            if (previousAudio) {
                let currentStep = 0;

                const crossfadeTimer = setInterval(() => {
                    currentStep++;
                    // 1. Fade OLD track out
                    if (previousAudio.volume > VOLUME_STEP) {
                        previousAudio.volume -= VOLUME_STEP;
                    } else {
                        previousAudio.volume = 0;
                    }
                    // 2. Fade NEW track in
                    if (newAudio.volume < 1 - VOLUME_STEP) {
                        newAudio.volume += VOLUME_STEP;
                    } else {
                        newAudio.volume = 1;
                    }
                    // 3. Stop when fade is complete
                    if (currentStep >= CROSSFADE_STEPS) {
                        clearInterval(crossfadeTimer);
                        previousAudio.pause();
                        previousAudio.volume = 0;
                        previousAudio.currentTime = 0; 
                    }
                }, CROSSFADE_INTERVAL);

            } else {
                // First track: simple fade-in
                let currentVolume = 0;
                const fadeInTimer = setInterval(() => {
                    currentVolume += VOLUME_STEP;
                    if (currentVolume >= 1) {
                        newAudio.volume = 1;
                        clearInterval(fadeInTimer);
                    } else {
                        newAudio.volume = currentVolume;
                    }
                }, CROSSFADE_INTERVAL);
            }
        }


        // Rendering Functions 
        function renderTextSection(text) {
            contentArea.innerHTML = `
                <div class="text-section">
                    <div class="text-content" id="fading-text">${text}</div>
                </div>
            `;
            // Clean up any playing video 
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.remove(); 
                currentVideo = null;
            }
            // Hide the mobile video prompt if it was visible
            mobileVideoPrompt.classList.add('hidden');

            setTimeout(() => {
                document.getElementById('fading-text').classList.add('visible');
            }, 50);
        }

        // ‚≠êÔ∏è MODIFIED: Logic for text_array to append lines with guaranteed fade-in ‚≠êÔ∏è
        function renderTextArraySection(textArray, itemDuration, trackUrl) {
            contentArea.innerHTML = `
                <div class="text-section">
                    <div class="text-content" id="growing-text-content"></div>
                </div>
            `;
            
            // Clean up media
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.remove();
                currentVideo = null;
            }
            mobileVideoPrompt.classList.add('hidden');

            const growingTextElement = document.getElementById('growing-text-content');
            let itemIndex = 0;

            // Start or crossfade audio once
            if (trackUrl) {
                playTrack(trackUrl);
            } else if (currentAudio) {
                currentAudio.pause();
                currentAudio.volume = 0;
                currentAudio = null;
            }


            function displayNextItem() {
                if (itemIndex >= textArray.length) {
                    // All items displayed, wait for the final duration before moving
                    // We use the itemDuration of the last item for the wait time
                    setTimeout(nextSection, itemDuration); 
                    return;
                }

                // 1. Create a new line element
                const newLine = document.createElement('span');
                newLine.classList.add('text-array-line');
                newLine.innerHTML = textArray[itemIndex];
                
                // 2. Append the new line (it starts hidden due to CSS opacity: 0)
                growingTextElement.appendChild(newLine);
                
                // 3. Force reflow to ensure the transition starts fresh
                newLine.offsetHeight; 

                // 4. Fade in the new line (using a small delay to ensure CSS transition works)
                setTimeout(() => {
                    newLine.classList.add('visible');
                }, 50);


                // 5. Schedule next action (wait for the item's duration)
                itemIndex++;
                setTimeout(displayNextItem, itemDuration);
            }

            // Initial call
            setTimeout(displayNextItem, 50);
        }
        // ‚≠êÔ∏è END MODIFIED renderTextArraySection ‚≠êÔ∏è

        function renderPhotoSection(imageUrls, delayMs) {
            contentArea.innerHTML = '';
            // Clean up any playing video 
            if (currentVideo) {
                currentVideo.pause();
                currentVideo.remove(); 
                currentVideo = null;
            }
            // Hide the mobile video prompt if it was visible
            mobileVideoPrompt.classList.add('hidden');

            const orderedImages = [...imageUrls];

            orderedImages.forEach((imgUrl, index) => {
                const img = document.createElement('img');
                img.src = imgUrl;
                img.classList.add('stack-image');

                const randomRotation = getRandomInt(-8, 8);
                contentArea.appendChild(img);

                img.onload = () => {
                    setTimeout(() => {
                        img.offsetHeight;
                        img.classList.add('visible');
                        img.style.transform = `translate(-50%, -50%) rotate(${randomRotation}deg)`;
                    }, index * delayMs);
                };
            });
        }
        
        // ‚≠êÔ∏è NEW: Logic to start video playback ‚≠êÔ∏è
        function startVideoPlayback(videoElement, duration) {
            // 1. FADE IN VIDEO
            videoElement.classList.add('visible');

            // 2. ATTEMPT PLAYBACK
            videoElement.play().catch(error => {
                console.error("Video Playback Failed:", error);
                // On failure, rely on the fallback timeout
            });

            // 3. FALLBACK TIMEOUT: If 'ended' event doesn't fire or video stops/fails silently.
            const videoTimeoutId = setTimeout(() => {
                console.warn("Video duration timeout reached. Moving to next section (Fallback).");
                if (videoElement) {
                    videoElement.pause();
                }
                nextSection(); 
            }, duration + 1000); // Add a 1s buffer

            // 4. ADD ENDED LISTENER: Move to the next section when the video completes.
            videoElement.addEventListener('ended', function handleVideoEnd() {
                console.log("Video playback ended. Moving to next section.");
                clearTimeout(videoTimeoutId); 
                nextSection();
            }, { once: true });
        }


        // ‚≠êÔ∏è MODIFIED: Render Video Section function ‚≠êÔ∏è
        function renderVideoSection(videoUrl, duration) {
            contentArea.innerHTML = `
                <div class="video-container">
                    <video id="cinematic-video" src="${videoUrl}" playsinline preload="auto"></video>
                </div>
            `;
            
            // Stop current audio (immediate stop)
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.volume = 0;
                currentAudio = null;
            }

            currentVideo = document.getElementById('cinematic-video');
            currentVideo.volume = 1; 

            if (isMobile) {
                // MOBILE: Show the manual play button (Click 3)
                mobileVideoPrompt.classList.remove('hidden');
                videoPlayButton.addEventListener('click', function handleMobilePlay() {
                    mobileVideoPrompt.classList.add('hidden');
                    // Start video and its flow control
                    startVideoPlayback(currentVideo, duration);
                    // Remove listener to prevent re-trigger
                    videoPlayButton.removeEventListener('click', handleMobilePlay);
                }, { once: true });

            } else {
                // DESKTOP: Autoplay immediately (due to the successful unlock hack)
                startVideoPlayback(currentVideo, duration);
            }
        }


        // Main Flow Control (Modified to handle 'text_array')
        function nextSection() {
            if (currentSectionIndex >= pageContent.length) {
                // STORY ENDED
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.volume = 0;
                }
                if (currentVideo) {
                    currentVideo.pause();
                }
                mobileVideoPrompt.classList.add('hidden');
                releaseWakeLock(); 
                return;
            }

            const section = pageContent[currentSectionIndex];
            const previousSection = pageContent[currentSectionIndex - 1];

            // 1. Play the new track (Crossfade Logic)
            if (section.type !== 'video' && section.track) {
                playTrack(section.track);
            } else if (section.type !== 'video' && section.type !== 'text_array' && currentAudio) {
                // Only stop audio if the new section is NOT a video/text_array
                currentAudio.pause();
                currentAudio.volume = 0;
                currentAudio = null; 
            }

            // --- LOGIC FOR CONTENT TRANSITIONS ---
            let isContinuousSection = false;
            if (currentSectionIndex > 0 && previousSection && previousSection.type === 'text' && section.type === 'photos' && previousSection.track === section.track) {
                isContinuousSection = true;
            }

            // 2. Determine if we need to fade out previous content
            if (!isContinuousSection) {
                contentArea.style.opacity = 0;
            }

            // 3. Set the delay based on continuity
            const renderDelay = isContinuousSection ? 50 : 1000;

            setTimeout(() => {

                // 4. Render new content
                if (section.type === 'text') {
                    renderTextSection(section.content);
                } else if (section.type === 'text_array') { // <-- NEW LOGIC
                    // The audio is handled inside renderTextArraySection
                    renderTextArraySection(section.content, section.duration, section.track);
                } else if (section.type === 'photos') {
                    const photoDelay = section.photoDelay || 3000;
                    renderPhotoSection(section.content, photoDelay);
                } else if (section.type === 'video') {
                    renderVideoSection(section.content, section.duration);
                }

                // 5. Fade new content in
                contentArea.style.opacity = 1;

                // 6. Set timer for the next section
                currentSectionIndex++;
                
                // CRITICAL FIX: Only set the timeout for non-video and non-text_array sections.
                // The video and text_array sections manage the call to nextSection() internally.
                if (section.type !== 'video' && section.type !== 'text_array' && section.duration < 999999) {
                    setTimeout(nextSection, section.duration);
                }

            }, renderDelay);
        }

        // ‚ö°Ô∏è INITIALIZATION FLOW CONTROL ‚ö°Ô∏è

        // Step 2: Starts the story once audio is confirmed unlocked (Click 2)
        function startCinematicStorySequence() {
            unmuteOverlay.style.opacity = 0;
            
            // üîí REQUEST THE WAKE LOCK HERE (Triggered by Click 2)
            requestWakeLock();

            setTimeout(() => {
                unmuteOverlay.style.display = 'none';
                nextSection();
            }, 1000 + INITIAL_DELAY_AFTER_UNLOCK); // Wait for fade-out + buffer
        }

        // Step 1: Initiated by the *very first* user click.
        function handleFirstTap() {
            if (hasStarted) return;
            hasStarted = true; 

            // IMPORTANT: Remove the click handler immediately to prevent accidental second click
            unmuteOverlay.removeEventListener('click', handleFirstTap);

            // CRITICAL: We run the sequential unlock, which manages the visual feedback (spinner/text change).
            runSequentialUnlock();
        }

        window.onload = function() {
            initializeAudio(); 
            // The first click runs the unlock process (handleFirstTap)
            unmuteOverlay.addEventListener('click', handleFirstTap, { once: true });
            
            // ‚ö†Ô∏è Add event listener to handle Wake Lock if user navigates away and comes back
            document.addEventListener('visibilitychange', () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    requestWakeLock();
                }
            });
        };
    </script>
</body>
</html>